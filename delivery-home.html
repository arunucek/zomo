<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Dashboard - Unicart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-truck me-2"></i>Unicart
            </a>
            <div class="ms-auto">
                <button class="btn btn-outline-light btn-sm" id="deliveryLogoutBtn"><i class="fas fa-right-from-bracket me-1"></i>Logout</button>
            </div>
        </div>
    </nav>

    <section class="py-5">
        <div class="container">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-route me-2"></i>Your Deliveries <span id="notify-badge" class="badge bg-danger ms-2" style="display:none;">New</span></h5>
                </div>
                <div class="card-body">
                    <div id="delivery-welcome" class="mb-3 text-muted"></div>
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>ETA</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody id="my-deliveries-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Details Modal -->
    <div class="modal fade" id="deliveryDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-user me-2"></i>Delivery Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div><strong>Order:</strong> <span id="dmod-order"></span></div>
                    <div><strong>Customer:</strong> <span id="dmod-name"></span></div>
                    <div><strong>Email:</strong> <span id="dmod-email"></span></div>
                    <div><strong>Phone:</strong> <span id="dmod-phone"></span></div>
                    <div class="mt-2"><strong>Address:</strong><br><span id="dmod-address"></span></div>
                    <div class="mt-2"><strong>Your current location:</strong><br><small id="dmod-currentloc">Unknown</small></div>
                </div>
                <div class="modal-footer">
                    <a id="dmod-map" class="btn btn-outline-primary" target="_blank"><i class="fas fa-map"></i> Open in Maps</a>
                    <a id="dmod-directions" class="btn btn-outline-success" target="_blank"><i class="fas fa-location-arrow"></i> Directions</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!requireDeliveryUser()) return;
            const u = getCurrentDeliveryUser();
            const welcome = document.getElementById('delivery-welcome');
            if (welcome && u) welcome.textContent = `Logged in as ${u.name} (${u.email})`;

            // If nothing assigned yet, try auto-assigning a confirmed order to this user
            const assigned = autoAssignForCurrentDeliveryUser();

            const tbody = document.getElementById('my-deliveries-table');
            const orders = getOrders();
            const mine = orders.filter(o => o.delivery && o.delivery.assignedDeliveryMan && o.delivery.assignedDeliveryMan.id === u.id);
            tbody.innerHTML = '';
            mine.forEach(o => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-order-id', o.id);
                const statusColor = o.status === 'out_for_delivery' ? 'primary' : o.status === 'processing' ? 'warning' : o.status === 'delivered' ? 'success' : 'secondary';
                const custName = (o.customer && (o.customer.firstName || o.customer.lastName)) ? `${o.customer.firstName || ''} ${o.customer.lastName || ''}`.trim() : (o.customer?.name || 'Unknown');
                const eta = o.delivery?.estimatedDelivery || '-';
                const actions = o.status === 'processing'
                    ? `<button class="btn btn-sm btn-outline-primary me-2" onclick="startDelivery('${o.id}')"><i class=\"fas fa-play\"></i> Accept</button>
                       <button class="btn btn-sm btn-outline-danger me-2" onclick="rejectAssignedDelivery('${o.id}')"><i class=\"fas fa-times\"></i> Reject</button>
                       <button class="btn btn-sm btn-outline-secondary" onclick="openDeliveryDetails('${o.id}')"><i class=\"fas fa-info-circle\"></i> Details</button>`
                    : o.status === 'out_for_delivery'
                    ? `<button class="btn btn-sm btn-outline-success me-2" onclick="completeDeliveryPrompt('${o.id}')"><i class=\"fas fa-check\"></i> Complete</button>
                       <button class="btn btn-sm btn-outline-secondary" onclick="openDeliveryDetails('${o.id}')"><i class=\"fas fa-map\"></i> Details</button>`
                    : `<button class="btn btn-sm btn-outline-secondary" onclick="openDeliveryDetails('${o.id}')"><i class=\"fas fa-info-circle\"></i> Details</button>`;

                tr.innerHTML = `
                    <td>${o.id}</td>
                    <td>${custName}<br><small class="text-muted">${o.customer?.phone || ''}</small></td>
                    <td><span class="badge bg-${statusColor}">${o.status.replace('_',' ')}</span></td>
                    <td><small>${eta}</small></td>
                    <td class="text-end actions-cell">${actions}</td>`;
                tbody.appendChild(tr);
            });

            document.getElementById('deliveryLogoutBtn')?.addEventListener('click', function(){
                deliveryLogout();
                window.location.href = 'delivery-login.html';
            });

            // Show notification if admin assigned new orders
            const notifyKey = `delivery_notify_${u.id}`;
            const pendingNotes = JSON.parse(localStorage.getItem(notifyKey) || '[]');
            if (pendingNotes.length > 0) {
                document.getElementById('notify-badge').style.display = 'inline-block';
                // Clear after showing once
                localStorage.removeItem(notifyKey);
            }
        });
    </script>
</body>
</html>


